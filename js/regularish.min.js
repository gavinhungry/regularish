/*
 (C) 2013 Gavin Lloyd <gavinhungry@gmail.com>
 Regularish: a JavaScript regular expression editor
*/
var Regularish=function(){return{App:Backbone.View.extend({el:"body",initialize:function(){this.$("#pattern").trigger("focus");this.$("#tab").on("click",_.bind(function(){this.$("#drawer").sladeToggle()},this));this.regex=new Regularish.Regex;this.router=new Regularish.Router;this.router.on("route:load",this.updateRegex,this);this.regex.on("change:pattern change:flags change:string",this.updateRoute,this);this.render();Backbone.history.start()},getRegex:function(a){var c;try{var b=atob(a),d=JSON.parse(b);
c={pattern:decodeURI(d.p),flags:decodeURI(d.f),string:decodeURI(d.s)}}catch(e){c={pattern:"(\\/) (o,,o) (\\/)",flags:"",string:"Need a regular expression? Why not Zoidberg?\n/ o,,o /"}}finally{return c}},updateRegex:function(a){a=this.getRegex(a);this.regex.set(a);this.regex.trigger("update")},getRoute:function(a){a={p:encodeURI(a.get("pattern")),f:encodeURI(a.get("flags")),s:encodeURI(a.get("string"))};if(!a.p&&!a.f&&!a.s)return"";a=JSON.stringify(a);return btoa(a)},updateRoute:function(){var a=
this.getRoute(this.regex);a?this.router.navigate("perm/"+a,{replace:!0}):this.router.navigate("",{replace:!0})},render:function(){new Regularish.RegexView({model:this.regex})}}),Router:Backbone.Router.extend({routes:{"perm/*splat":"load"}}),Template:function(){var a={},c=function(b){var c=a[b]||$.get("/templates/"+b+".html");return a[b]=c};return{preload:function(a){_.each(a,c)},get:function(a,d,e){c(a).done(function(a){d.call(e,a)})}}}(),Regex:Backbone.Model.extend({defaults:{pattern:"",flags:"",
string:""},initialize:function(){this.on("change:pattern change:flags",this.updateRegex);this.updateRegex()},updateRegex:function(){this.unset("re");this.unset("error");try{this.set("re",RegExp(this.get("pattern"),this.get("flags")))}catch(a){this.set("error",a)}},getMatches:function(){var a=this.attributes,c=a.re,b=[],d=[];if(c instanceof RegExp)for(var a=a.string.split("\n"),e,f=0;f<a.length;f++){for(var l=a[f],g=[],h=[];e=c.exec(l);){var k=e.index,m=k+e[0].length;g.push({from:k,to:m});(c.global||
0===h.length)&&0<e.length&&h.push(_.filter(_.rest(e,1),function(a){return void 0!==a&&0<a.length}));if(0===m)break;l=l.substr(m);c.lastIndex=0}b.push(g);_.each(h,function(a){_.isEmpty(a)||d.push(a)});c.lastIndex=0}return{matches:b,groups:d}}}),RegexView:Backbone.View.extend({el:"#regex",initialize:function(){var a=this;this.render();this.model.on("update",this.updateFields,this);this.model.on("change",this.updateView,this);this.$("#pattern, #flags, #string").each(function(){var c=$(this);c.on("input keyup",
function(){var b=c.val();c.data("cached")!==b&&(c.data("cached",b),a.updateModel())})})},updateModel:function(){this.model.set({pattern:this.$pattern.val(),flags:this.$flags.val(),string:this.$string.val()})},updateFields:function(){var a=this.model.attributes;this.$pattern.val(a.pattern);this.$flags.val(a.flags);this.$string.val(a.string)},updateView:function(){var a=this.model.attributes;void 0===a.error?this.$notice.sladeUp(function(){this.$error.val(a.error)}):(this.$error.val(a.error),this.$notice.sladeDown());
for(var c=a.string.split("\n"),b=this.model.getMatches(),d=b.matches,e=b.groups,b="",f=0;f<d.length;f++){for(var l=d[f],g=c[f],h=0;h<l.length;h++){var k=l[h],b=b+_.escape(g.slice(0,k.from)),m=_.escape(g.slice(k.from,k.to));0<m.length&&(b+="<span>"+m+"</span>");g=g.slice(k.to)}b+=_.escape(g)+"<br>"}0===b.length||"<br>"===b?this.$matches.hide().html(""):this.$matches.html(b).show();Regularish.Template.get("groups",function(a){a=_.template(a,{groups:e});0===a.length||"\n"===a?this.$groups.hide().html(""):
this.$groups.html(a).show()},this)},render:function(){this.$pattern=this.$("#pattern");this.$flags=this.$("#flags");this.$string=this.$("#string");this.$notice=this.$("#notice");this.$error=this.$("#error");this.$matches=this.$("#matches");this.$groups=this.$("#groups");this.updateView()}})}}();
