var Regularish=function(){"use strict";return{App:Backbone.View.extend({el:"body",initialize:function(){$("#pattern").trigger("focus"),$("#tab").on("click",function(){$("#reference").stop().fadeToggle("fast"),$("#drawer").stop().animate({height:"toggle"},"fast")}),this.regex=new Regularish.Regex,this.router=new Regularish.Router,this.router.on("route:load",this.updateRegex,this),this.regex.on("change:pattern change:flags change:string",this.updateRoute,this),Backbone.history.start(),this.render()},updateRegex:function(e){try{var t=atob(e),n=JSON.parse(t);this.regex.set({pattern:decodeURI(n.p),flags:decodeURI(n.f),string:decodeURI(n.s)})}catch(r){this.regex.set({pattern:"(\\/) (o,,o) (\\/)",flags:"",string:"Need a regular expression? Why not Zoidberg?\n/ o,,o /"})}},updateRoute:function(){var e={p:encodeURI(this.regex.get("pattern")),f:encodeURI(this.regex.get("flags")),s:encodeURI(this.regex.get("string"))};if(!e.p&&!e.f&&!e.s){this.router.navigate("",{replace:!0});return}var t=JSON.stringify(e),n=btoa(t);this.router.navigate("perm/"+n,{replace:!0})},render:function(){new Regularish.RegexView({model:this.regex})}}),Router:Backbone.Router.extend({routes:{"perm/*splat":"load"}}),Template:function(){var e={},t=function(t){var n=e[t]||$.get("templates/"+t+".html");return e[t]=n,n};return{preload:function(e){_.each(e,t)},get:function(e,n,r){var i=t(e);i.done(function(e){n.call(r,e)})}}}(),Regex:Backbone.Model.extend({defaults:{pattern:"",flags:"",string:""},initialize:function(){this.on("change:pattern change:flags",this.updateRegex),this.updateRegex()},updateRegex:function(){this.unset("re"),this.unset("error");try{this.set("re",new RegExp(this.get("pattern"),this.get("flags")))}catch(e){this.set("error",e)}},getMatches:function(){var e=this.attributes,t=e.re,n=[],r=[];if(t instanceof RegExp){var i=e.string.split("\n"),s;for(var o=0;o<i.length;o++){var u=i[o],a=[],f=[];while(s=t.exec(u)){var l=s.index,c=l+s[0].length;a.push({from:l,to:c}),(t.global||f.length===0)&&s.length>0&&f.push(_.filter(_.rest(s,1),function(e){return e!==undefined&&e.length>0}));if(c===0)break;u=u.substr(c),t.lastIndex=0}n.push(a),_.each(f,function(e){_.isEmpty(e)||r.push(e)}),t.lastIndex=0}}return{matches:n,groups:r}}}),RegexView:Backbone.View.extend({el:"#regex",initialize:function(){this.render(),this.model.on("change",this.updateView,this);var e=this;$("#pattern, #flags, #string").each(function(){var t=$(this);t.on("input keyup",function(){t.data("cached")!==t.val()&&(t.data("cached",t.val()),e.updateModel())})})},updateModel:function(){this.model.set({pattern:this.$pattern.val(),flags:this.$flags.val(),string:this.$string.val()})},updateView:function(){var e=this.model.attributes;this.$pattern.val(e.pattern),this.$flags.val(e.flags),this.$string.val(e.string),this.$error.val(e.error),e.error===undefined?this.$wrap.stop().sladeUp("fast"):this.$wrap.sladeDown("fast");var t=e.string.split("\n"),n=this.model.getMatches(),r=n.matches,i=n.groups,s="";for(var o=0;o<r.length;o++){var u=r[o],a=t[o];for(var f=0;f<u.length;f++){var l=u[f];s+=_.escape(a.slice(0,l.from));var c=_.escape(a.slice(l.from,l.to));c.length>0&&(s+="<span>"+c+"</span>"),a=a.slice(l.to)}s+=_.escape(a)+"<br>"}this.$matches.html(s==="<br>"?"":s),Regularish.Template.get("groups",function(e){var t=_.template(e,{groups:i});this.$groups.html(t==="\n"?"":t)},this)},render:function(){this.$pattern=this.$("#pattern"),this.$flags=this.$("#flags"),this.$string=this.$("#string"),this.$wrap=this.$("#wrap"),this.$error=this.$("#error"),this.$matches=this.$("#matches"),this.$groups=this.$("#groups"),this.updateView()}})}}();